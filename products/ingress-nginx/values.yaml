ingress-nginx:
  controller:
    allowSnippetAnnotations: true
    config:
      plugins: "crowdsec"
      lua-shared-dicts: "crowdsec_cache: 50m"
      use-forwarded-headers: "true"
      server-snippet : |
        resolver local=on ipv6=off;
    ingressClassResource:
      default: true

    kind: Deployment
    replicaCount: 2
    minAvailable: 0
    maxUnavailable: 2

    service:
      nodePorts:
        http: 32080
        https: 32443
      externalIPs:
        - 31.201.251.186

    resources:
      limits:
        memory: 768Mi
      requests:
        cpu: 100m
        memory: 256Mi

    minReadySeconds: 30

    metrics:
      enabled: true
      serviceMonitor:
        enabled: true

    extraVolumes:
      - name: crowdsec-bouncer-plugin
        emptyDir: {}

    extraInitContainers:
      - name: init-clone-crowdsec-bouncer
        image: crowdsecurity/lua-bouncer-plugin
        imagePullPolicy: IfNotPresent
        env:
          - name: API_URL
            value: "http://crowdsec-service.crowdsec.svc.cluster.local:8080"
          - name: API_KEY
            valueFrom:
              secretKeyRef:
                name: crowdsec-api-key
                key: API_KEY
          - name: BOUNCER_CONFIG
            value: "/crowdsec/crowdsec-bouncer.conf"
        command:
          [
            "sh",
            "-c",
            "apk update; apk add bash; bash /docker_start.sh; mkdir -p /lua_plugins/crowdsec/; cp -R /crowdsec/* /lua_plugins/crowdsec/",
          ]
        volumeMounts:
          - name: crowdsec-bouncer-plugin
            mountPath: /lua_plugins

    extraVolumeMounts:
      - name: crowdsec-bouncer-plugin
        mountPath: /etc/nginx/lua/plugins/crowdsec
        subPath: crowdsec

  revisionHistoryLimit: 2

  defaultBackend:
    enabled: true
    image:
      repository: ghcr.io/tarampampam/error-pages
      tag: 2.26.0
    extraEnvs:
      - name: TEMPLATE_NAME
        value: ghost
      - name: SHOW_DETAILS
        value: 'true'
    resources:
      limits:
        memory: 20Mi
      requests:
        cpu: 10m
        memory: 10Mi
