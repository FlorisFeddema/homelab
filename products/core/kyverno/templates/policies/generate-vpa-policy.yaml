apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: generate-vpa-for-workloads
  annotations:
    policies.kyverno.io/title: Add VPA resource for workload
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/description: >-
        This policy automatically generates a VerticalPodAutoscaler (VPA) resource for Deployments, StatefulSets, and DaemonSets to help manage and optimize resource usage.
        The VPA resource is created in the same namespace as the workload and is linked via owner references.
        Namespaces such as kube-system, kyverno, longhorn-system, kube-public, and kube-node-lease are excluded from this policy.
        Additionally, workloads labeled with 'feddema.dev/vpa-autogen: "false"' will not have a VPA generated.
spec:
  generateExisting: true
  rules:
    - name: generate-vpa
      skipBackgroundRequests: true
      match:
        resources:
          kinds:
            - Deployment
            - StatefulSet
            - DaemonSet
      exclude:
        resources:
          namespaces:
            - kube-system
            - kyverno
            - longhorn-system
            - kube-public
            - kube-node-lease
          selector:
            matchLabels:
              feddema.dev/vpa-autogen: "false"
      generate:
        apiVersion: autoscaling.k8s.io/v1
        kind: VerticalPodAutoscaler
        name: "{{`{{request.object.metadata.name}}`}}"
        namespace: "{{`{{request.object.metadata.namespace}}`}}"
        synchronize: true
        data:
          metadata:
            labels:
              generated-by: kyverno
            ownerReferences:
              - apiVersion: "{{`{{request.object.apiVersion}}`}}"
                kind: "{{`{{request.object.kind}}`}}"
                name: "{{`{{request.object.metadata.name}}`}}"
                uid: "{{`{{request.object.metadata.uid}}`}}"
                controller: true
                blockOwnerDeletion: true
          spec:
            targetRef:
              apiVersion: "{{`{{request.object.apiVersion}}`}}"
              kind: "{{`{{request.object.kind}}`}}"
              name: "{{`{{request.object.metadata.name}}`}}"
            updatePolicy:
              updateMode: "Off"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: admission-controller
    app.kubernetes.io/instance: kyverno
    app.kubernetes.io/part-of: kyverno
  name: kyverno:generate-vpa-policy
rules:
  - apiGroups:
      - "autoscaling.k8s.io"
    resources:
      - verticalpodautoscalers
    verbs:
      - get
      - delete
      - update
      - create
      - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kyverno:generate-vpa-policy-background
  labels:
    app.kubernetes.io/component: background-controller
    app.kubernetes.io/instance: kyverno
    app.kubernetes.io/part-of: kyverno
subjects:
  - kind: ServiceAccount
    name: kyverno-background-controller
    namespace: kyverno
roleRef:
  kind: ClusterRole
  name: kyverno:generate-vpa-policy
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kyverno:generate-vpa-policy-admission
  labels:
    app.kubernetes.io/component: admission-controller
    app.kubernetes.io/instance: kyverno
    app.kubernetes.io/part-of: kyverno
subjects:
  - kind: ServiceAccount
    name: kyverno-admission-controller
    namespace: kyverno
roleRef:
  kind: ClusterRole
  name: kyverno:generate-vpa-policy
  apiGroup: rbac.authorization.k8s.io
